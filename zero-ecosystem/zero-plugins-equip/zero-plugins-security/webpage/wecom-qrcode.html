<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>åç«¯æ‰˜ç®¡æ¨¡å¼ - ç™»å½•æµ‹è¯• (JSONè¿”å›ç‰ˆ)</title>
    <style>
        /* æ ·å¼ä¿æŒä¸å˜ */
        body {
            font-family: sans-serif;
            padding: 40px;
            text-align: center;
            background-color: #f0f2f5;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: 0 auto;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .step {
            margin: 15px 0;
            padding: 10px;
            background: #f9f9f9;
            border-left: 4px solid #0082EF;
            text-align: left;
        }

        .step-title {
            font-weight: bold;
            color: #0082EF;
        }

        .btn {
            background-color: #0082EF;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .btn:hover {
            background-color: #0066cc;
        }

        .token-display {
            background: #333;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
            text-align: left;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        .error {
            color: red;
            margin-top: 10px;
        }

        code {
            background: #eee;
            padding: 2px 5px;
            border-radius: 3px;
            color: #c7254e;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ§© ä¼å¾®æ‰«ç ç™»å½•æµ‹è¯• (APIè·å–é“¾æ¥ç‰ˆ)</h2>

    <div id="login-view">
        <div class="step">
            <div class="step-title">ç¬¬ä¸€æ­¥ (Init)</div>
            å‰ç«¯è¯·æ±‚ <code>/wecom-init</code>ï¼Œè·å–æ ¸å¿ƒå‡­è¯ <b>State</b>ã€‚
        </div>
        <div class="step">
            <div class="step-title">ç¬¬äºŒæ­¥ (QRCode Data)</div>
            å‰ç«¯è¯·æ±‚ <code>/wecom-qrcode</code> æ¥å£è·å– JSONï¼Œæå– <b>qrUrl</b> å¹¶è·³è½¬ã€‚
        </div>

        <button class="btn" onclick="startTestFlow()">ğŸš€ å¼€å§‹æµ‹è¯•æµç¨‹</button>
        <p id="loading-msg" style="color: gray; display: none;">æ­£åœ¨åˆå§‹åŒ–...</p>
        <p class="error" id="error-msg"></p>
    </div>

    <div class="hidden" id="success-view">
        <div class="step">
            <div class="step-title">ç¬¬ä¸‰æ­¥ (Callback & Token)</div>
            é—­ç¯å®Œæˆï¼åç«¯å·²é€šè¿‡ Redirect å°†æµè§ˆå™¨é€å›æ­¤é¡µé¢ï¼Œå¹¶æºå¸¦äº† Tokenã€‚
        </div>
        <h3 style="color: green;">âœ… è®¤è¯æˆåŠŸ</h3>
        <div>æ‚¨çš„ Token:</div>
        <div class="token-display" id="token-box"></div>
        <div style="margin-top: 20px;">
            <a href="javascript:clearAndRetry()" style="color: #666;">æ¸…é™¤ Token å¹¶é‡æ–°æµ‹è¯•</a>
        </div>
    </div>
</div>

<script>
    // ================= é…ç½®åŒºåŸŸ =================
    const API_HOST = 'http://localhost:7085';
    const API_PATHS = {
        INIT: '/auth/wecom-init',
        QRCODE: '/auth/wecom-qrcode'
    };
    // ===========================================

    window.onload = function () {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        if (token) {
            showSuccess(token);
        }
    };

    async function startTestFlow() {
        const btn = document.querySelector('.btn');
        const errorMsg = document.getElementById('error-msg');
        const loadingMsg = document.getElementById('loading-msg');

        btn.disabled = true;
        loadingMsg.style.display = 'block';
        errorMsg.textContent = '';

        try {
            const targetUrl = encodeURIComponent(window.location.href.split('?')[0]);

            // ==========================================
            // 1. è¯·æ±‚ Init æ¥å£
            // ==========================================
            loadingMsg.textContent = '1. æ­£åœ¨è¯·æ±‚ Init è·å– State...';
            const initResponse = await fetch(`${API_HOST}${API_PATHS.INIT}?targetUrl=${targetUrl}`);
            const initData = (await initResponse.json()).data;
            if (!initData || !initData.state) {
                throw new Error('Init æ¥å£è¿”å›é”™è¯¯ï¼Œæœªæ‰¾åˆ° state å­—æ®µ');
            }

            console.log("è·å–åˆ° State:", initData.state);

            // ==========================================
            // 2. è¯·æ±‚ QRCode æ¥å£ (æ ¸å¿ƒä¿®æ”¹å¤„)
            // ==========================================
            loadingMsg.textContent = '2. æ­£åœ¨è¯·æ±‚åç«¯è·å–ä¼å¾®äºŒç»´ç é“¾æ¥...';

            // æ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯ç›´æ¥è·³è½¬ï¼Œè€Œæ˜¯ fetch è¯·æ±‚æ•°æ®
            const qrcodeApiUrl = `${API_HOST}${API_PATHS.QRCODE}?state=${initData.state}`;
            const qrResponse = await fetch(qrcodeApiUrl);
            const qrData = (await qrResponse.json()).data;

            console.log("QRCode æ¥å£è¿”å›:", qrData);

            // ==========================================
            // 3. è§£æ JSON å¹¶è·³è½¬
            // ==========================================
            if (qrData && qrData.qrUrl) {
                loadingMsg.textContent = '3. è·å–é“¾æ¥æˆåŠŸï¼Œæ­£åœ¨è·³è½¬è‡³ä¼ä¸šå¾®ä¿¡...';
                // ç¨å¾®å»¶è¿Ÿä¸€ä¸‹è®©äººçœ¼èƒ½çœ‹æ¸…æµç¨‹ï¼ˆå¯é€‰ï¼‰
                setTimeout(() => {
                    window.location.href = qrData.qrUrl;
                }, 500);
            } else {
                throw new Error('QRCode æ¥å£æœªè¿”å›æœ‰æ•ˆçš„ qrUrl');
            }

        } catch (e) {
            console.error(e);
            errorMsg.textContent = 'æµç¨‹ä¸­æ–­: ' + e.message;
            btn.disabled = false;
            loadingMsg.style.display = 'none';
        }
    }

    function showSuccess(token) {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('success-view').classList.remove('hidden');
        document.getElementById('token-box').textContent = token;
        // æ¸…ç† URL å‚æ•°ï¼Œçœ‹ç€æ¸…çˆ½ç‚¹
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    function clearAndRetry() {
        window.location.href = window.location.pathname;
    }
</script>

</body>
</html>