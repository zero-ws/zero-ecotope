package io.zerows.epoch.bootplus.exploit.quiz;

import io.vertx.core.Future;
import io.vertx.core.json.JsonArray;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.unit.Async;
import io.vertx.ext.unit.TestContext;
import io.zerows.epoch.constant.KName;
import io.zerows.epoch.constant.KWeb;
import io.zerows.epoch.bootplus.exploit.atom.mock.QAsk;
import io.zerows.epoch.bootplus.exploit.atom.mock.QRequest;
import io.zerows.epoch.bootplus.extension.refine.Ox;
import io.zerows.epoch.bootplus.extension.uca.elasticsearch.EsIndex;
import io.zerows.epoch.bootplus.extension.uca.graphic.Plotter;
import io.zerows.epoch.bootplus.extension.uca.graphic.TopologyPlotter;
import io.zerows.epoch.bootplus.stellar.Ok;
import io.zerows.epoch.bootplus.stellar.owner.OkA;
import io.zerows.epoch.corpus.database.Database;
import io.zerows.platform.enums.Environment;
import io.zerows.platform.enums.typed.ChangeFlag;
import io.zerows.support.Ut;
import io.zerows.epoch.testsuite.JooqBase;
import io.zerows.extension.mbse.basement.atom.builtin.DataAtom;
import io.zerows.extension.mbse.basement.uca.jdbc.AoConnection;
import io.zerows.extension.mbse.basement.uca.jdbc.DataConnection;
import io.zerows.extension.mbse.basement.uca.jdbc.Pin;
import io.zerows.extension.mbse.basement.uca.metadata.AoBuilder;
import io.zerows.plugins.store.elasticsearch.ElasticSearchClient;
import io.zerows.plugins.store.elasticsearch.ElasticSearchInfix;
import io.zerows.plugins.store.neo4j.Neo4jClient;
import io.zerows.plugins.store.neo4j.Neo4jInfix;
import io.zerows.specification.access.app.HApp;
import io.zerows.specification.access.app.HArk;
import io.zerows.specification.modeling.operation.HDao;
import org.junit.Before;

import java.util.Objects;
import java.util.function.BiFunction;
import java.util.function.Consumer;

/**
 * Ox专用测试框架基类，测试路径如下：
 *
 * <pre><code>
 * - `mock/channel/cmdb-v2/dict-config/ucmdb.json`
 * - `mock/channel/cmdb-v2/dict-epsilon/ucmdb.json`
 * - `mock/channel/cmdb-v2/mapping/ucmdb.json`
 * - `mock/channel/cmdb-v2/options/ucmdb.json`
 * </code></pre>
 *
 * > 默认配置`ucmdb.json`可通过`connect`的API实现配置文件切换。
 *
 * @author <a href="http://www.origin-x.cn">Lang</a>
 */
public abstract class TestCasePlatform extends JooqBase {
    // 基本环境变量
    protected final transient Environment environment;
    protected transient OkA ok;

    // -------------------- 双构造方法 ---------------------
    public TestCasePlatform(final Environment environment) {
        this.environment = environment;
    }

    public TestCasePlatform() {
        this(Environment.Mockito);
    }

    // -------------------- 环境设置方法 ---------------------
    @Before
    @SuppressWarnings("all")
    public void setUp(final TestContext context, final Async async) {
        Ok.of(VERTX, Environment.Mockito).onSuccess(initialized -> {
            this.ok = initialized;
            this.logger().info("[ Qz ] Qz Framework has been initialized!!! Env = `{0}`", this.environment);
            final boolean runnable = this.setUpAfter(context, async);
            if (runnable) {
                async.complete();
            }
        });
    }

    public boolean setUpAfter(final TestContext context, final Async async) {
        return true;
    }

    // -------------------- 参数相关信息，平台端专用方法 ---------------------
    protected HArk ark() {
        return Objects.requireNonNull(this.ok).configArk();
    }

    protected Database database() {
        return Objects.requireNonNull(this.ok).configDatabase();
    }

    protected DataAtom atom(final String identifier) {
        final HApp app = this.ark().app();
        return Ox.toAtom(app.option(KName.APP_ID), identifier);
    }

    // -------------------- 访问器引用获取 ---------------------
    // 动态Dao
    protected HDao dbDao(final String identifier) {
        return Ox.toDao(this.atom(identifier));
    }

    // 元数据构造器
    protected AoBuilder dbBuilder() {
        final Database database = this.ok.configDatabase();
        final Pin pin = Pin.getInstance();
        return pin.getBuilder(database);
    }

    // 连接构造器
    protected AoConnection dbConnection() {
        final Database database = this.ok.configDatabase();
        return new DataConnection(database);
    }

    // Neo4J 绘图仪
    protected Plotter neo4P() {
        final HArk app = this.ok.configArk();
        final Plotter plotter = new TopologyPlotter();
        plotter.bind(app);
        return plotter;
    }

    // Neo4J 原生客户端
    protected Neo4jClient neo4j() {
        return Neo4jInfix.getClient().connect(KWeb.DEPLOY.VERTX_GROUP);
    }

    // Es 原生客户端
    protected ElasticSearchClient es() {
        return ElasticSearchInfix.getClient();
    }

    // Es 索引创建器
    protected EsIndex es(final ChangeFlag flag, final String identifier) {
        return EsIndex.create(flag, identifier);
    }

    // -------------------- 输入专用 ---------------------
    /*
     * 基础模型
     * {
     *     "identifier": "模型标识符",
     *     "key": "主键",
     *     "data": {
     *
     *     }
     * }
     */
    protected QAsk inData(final String filename) {
        final JsonObject raw = this.ioJObject(filename);
        final String identifier = raw.getString("identifier");
        final Object dataPart = raw.getValue("data");
        final String key = raw.getString("key");
        return this.inData(identifier, key, dataPart);
    }

    protected QAsk inData(final String identifier, final String key) {
        return this.inData(identifier, key, null);
    }

    protected QAsk inData(final String identifier, final Object dataPart) {
        return this.inData(identifier, null, dataPart);
    }

    protected QAsk inData(final String identifier, final String key, final Object dataPart) {
        final QAsk input;
        if (dataPart instanceof JsonArray) {
            input = new QAsk(this.atom(identifier), (JsonArray) dataPart);
        } else if (dataPart instanceof JsonObject) {
            input = new QAsk(this.atom(identifier), (JsonObject) dataPart);
        } else {
            if (Ut.isNotNil(key)) {
                input = new QAsk(this.atom(identifier), key);
            } else {
                throw new RuntimeException("构造 QAsk 异常，检查测试相关配置！");
            }
        }
        return input;
    }

    /*
     * 请求模型
     *     {
     *          "request": "请求唯一标识",
     *          "data": "支持两种格式，[]和{}，对应JsonObject和JsonArray",
     *          "headers": {
     *              "...": "请求头哈希表结构，存储appId, appKey, sigma等..."
     *          }
     *     }
     */
    protected QRequest inWeb(final String filename) {
        return new QRequest(this.ioJObject(filename));
    }

    protected QRequest inWeb(final String key, final Object dataPart) {
        final JsonObject data = new JsonObject();
        data.put("request", key);
        data.put("data", dataPart);
        return new QRequest(data);
    }

    /*
     * 写文件
     */
    protected void ioOut(final String filename, final JsonObject content) {
        if (Ut.isNotNil(filename)) {
            final String resolved = Ox.toRoot(filename, this.environment);
            Ut.ioOut(resolved, content);
        }
    }

    // -------------------- 子类专用 ---------------------
    protected <T> Consumer<String> tcDao(final TestContext context,
                                         final BiFunction<QAsk, HDao, Future<T>> consumer,
                                         final Consumer<T> callback) {
        return filename -> {
            final QAsk model = this.inData(filename);
            final HDao dao = this.dbDao(model.identifier());
            this.tcAsync(context, consumer.apply(model, dao), callback);
        };
    }

    protected <T> Consumer<String> tcDao(final TestContext context,
                                         final BiFunction<QAsk, HDao, Future<T>> consumer) {
        return filename -> {
            final QAsk model = this.inData(filename);
            final HDao dao = this.dbDao(model.identifier());
            this.tcAsync(context, consumer.apply(model, dao),
                actual -> this.logger().info("[ Qz ] 执行完成：{0}", actual));
        };
    }
}
