# =================================================================
# ğŸš€ YmBoot Zero Framework æ ¸å¿ƒé…ç½®æ–‡ä»¶ (Final Complete Version)
# -----------------------------------------------------------------
# ğŸ’¡ ç‰ˆæœ¬è¯´æ˜ï¼š
# 1. ç»“æ„ï¼šServer / Vertx (å«Datasource/Redis/Flyway) / Security / Integrations
# 2. æ³¨é‡Šï¼šå·²å®Œæ•´æ¢å¤æ–°ç‰ˆå…³äº OAuth2 ç”Ÿå‘½å‘¨æœŸã€ç­–ç•¥å»ºè®®åŠå¾®ä¿¡é…ç½®çš„è¯¦ç»†è¯´æ˜ã€‚
# 3. è„±æ•ï¼šæ•æ„Ÿä¿¡æ¯å·²ä½¿ç”¨å ä½ç¬¦å¤„ç†ã€‚
# =================================================================

# -----------------------------------------------------------------
# 1. ğŸŒ æœåŠ¡å™¨ä¸“ç”¨é…ç½® (Server)
# -----------------------------------------------------------------
server:
  port: ${Z_API_PORT:7185}                   # ---> ğŸ’»ï¸ HTTP æœåŠ¡ç«¯å£
  address: ${Z_API_HOST:0.0.0.0}
  session:
    options:
      httpOnly: true
  options:
    ssl: ${Z_API_SSL:false}
    useAlpn: true
  websocket:
    config:
      stomp:
        port: ${Z_API_PORT:7185}             # âš ï¸ å¿…é¡»ä¸ HTTP ç«¯å£ä¸€è‡´
        secured: true
        websocketBridge: true
        websocketPath: /api/web-socket

# -----------------------------------------------------------------
# 2. âš¡ Vert.x æ ¸å¿ƒå®¹å™¨ (Vertx)
# -----------------------------------------------------------------
vertx:
  application:
    name: ${Z_APP:r2mo-app-momo}

  # ğŸ—ï¸ çº¿ç¨‹æ± ä¸å®ä¾‹é…ç½®
  config:
    instance:
      - name: app-zero-secure-001
        options:
          maxEventLoopExecuteTime: 1200_000_000_000
          maxWorkerExecuteTime: 1200_000_000_000
          eventLoopPoolSize: 24              # ğŸš€ CPU * 2
          workerPoolSize: 128                # ğŸš€ IO å¯†é›†å‹å»ºè®®å€¼
          internalBlockingPoolSize: 32

    delivery:
      timeout: 180_000

    deployment:
      worker:
        instances: 32                        # ğŸš€ CPU * 2 ~ 4
        workerPoolSize: 128
      agent:
        instances: 24                        # ğŸš€ å¿…é¡» == eventLoopPoolSize

  mvc:
    cors:
      allow-credentials: true
      allowed-origins:
        - "*"

  # ---------------------------------------------------------------
  # 2.1 ğŸ—„ï¸ æ•°æ®æºé…ç½® (Datasource) - [In Vertx]
  # ---------------------------------------------------------------
  datasource:
    dynamic:
      primary: master
      strict: false
      datasource:
        # ğŸ† Master (æ–°ç‰ˆé…ç½®)
        master:
          url: ${Z_DBS_URL:jdbc:mysql://ox.engine.cn:3306/DB_HOTEL_004?useUnicode=true&characterEncoding=UTF-8&serverTimezone=Asia/Shanghai&useSSL=false&allowPublicKeyRetrieval=true}
          instance: ${Z_DBS_INSTANCE:DB_HOTEL_004}
          hostname: ${vertx.datasource.hostname}
          port: ${vertx.datasource.port}
          username: ${vertx.datasource.username}
          password: ${vertx.datasource.password}
          driver-class-name: "com.mysql.cj.jdbc.Driver"

        # ğŸ“š History (æ—§ç‰ˆç»“æ„)
        master-history:
          url: ${Z_DBS_HIS_URL:jdbc:mysql://...}
          username: ${Z_DBS_HIS_USER:root}
          password: ${Z_DBS_HIS_PASS:root}
          instance: ${Z_DBS_HIS_INSTANCE:DB_HIS}
          driver-class-name: "com.mysql.cj.jdbc.Driver"

        # ğŸ”„ Workflow (æ—§ç‰ˆç»“æ„)
        master-workflow:
          url: ${Z_DBS_WF_URL:jdbc:mysql://...}
          username: ${Z_DBS_WF_USER:root}
          password: ${Z_DBS_WF_PASS:root}
          instance: ${Z_DBS_WF_INSTANCE:DB_WF}
          driver-class-name: "com.mysql.cj.jdbc.Driver"

    hostname: ${Z_DB_HOST:ox.engine.cn}
    port: ${Z_DB_PORT:3306}
    username: ${Z_DB_APP_USER:r2mo}
    password: ${Z_DB_APP_PASS:r2mo}
    driver-class-name: "com.mysql.cj.jdbc.Driver"

    hikari:
      minimum-idle: 10

  # ---------------------------------------------------------------
  # 2.2 ğŸ—„ï¸ Redis é…ç½® (Data) - [In Vertx]
  # ---------------------------------------------------------------
  data:
    redis:
      host: ${R2MO_REDIS_HOST:127.0.0.1}
      port: ${R2MO_REDIS_PORT:6379}
      password: ${R2MO_REDIS_PASS:password}
      database: ${R2MO_REDIS_DB:0}
      timeout: 3000

  # ---------------------------------------------------------------
  # 2.3 ğŸ”„ æ•°æ®åº“è¿ç§» (Flyway) - [In Vertx]
  # ---------------------------------------------------------------
  flyway:
    enabled: true
    locations:
      - classpath:database/oauth2/${Z_DB_TYPE:MYSQL}/
      - classpath:plugins/${vertx.application.name}/flyway/${Z_DB_TYPE:MYSQL}/
      - classpath:plugins/${vertx.application.name}/database/${Z_DB_TYPE:MYSQL}/
    encoding: UTF-8
    sql-migration-prefix: V
    sql-migration-separator: __
    sql-migration-suffixes: .sql
    validate-on-migrate: false
    baseline-on-migrate: true
    baseline-version: 1
    clean-disabled: true

# -----------------------------------------------------------------
# 3. ğŸ›¡ï¸ å®‰å…¨ç­–ç•¥ (Security) - [Root Node]
# -----------------------------------------------------------------
security:
  # ğŸ“Œ LDAP é…ç½®
  ldap:
    enabled: true
    options:
      url: ldap://localhost:10389
      base: ou=system
      username: uid=admin,ou=system
      password: secret
      user-query:
        - "(uid={0})"
        - "(mail={0})"
      user-email: "mail"
      user-id: "uid"

  # ğŸ“Œ éªŒè¯ç é…ç½®
  captcha:
    enabled: false
  captcha-email:
    length: 6
    expiredAt: 300
    subject: ç™»å½•éªŒè¯ç é‚®ä»¶
  captcha-sms:
    expiredAt: 60
    length: 6
    template: SMS_498945473

  # ğŸ“Œ åŸºç¡€å®‰å…¨
  basic:
    realm: "Realm Default Zero"

  # ğŸ“Œ JWT é…ç½®
  jwt:
    enabled: true
    options:
      jwtOptions:
        algorithm: HS256
      keyStore:
        type: jceks
        path: keys/keystore.jceks
        password: zerows

  # -----------------------------------------
  # ğŸ“Œ OAuth2æœåŠ¡ç«¯ç­–ç•¥é…ç½® (å¯¹åº” OAuth2Configuration ç±»)
  # -----------------------------------------
  oauth2:
    # 1. åŸºç¡€å¼€å…³
    enabled: true             # å¯ç”¨ OAuth2 æ¨¡å—
    mode: JWT                 # æ¨¡å¼: JWT (æ— çŠ¶æ€) | OIDC | OPAQUE
    issuer: "https://auth.r2mo.io" # å‘è¡Œè€…æ ‡è¯† (éå¸¸é‡è¦ï¼Œå¯¹åº” payload çš„ iss)
    resourceEnabled: true     # æ˜¯å¦ä½œä¸ºèµ„æºæœåŠ¡å™¨æ‹¦æˆªè¯·æ±‚

    # 2. ç”Ÿå‘½å‘¨æœŸç®¡ç† (Time-to-Live Policy)
    # [æ–°å¢] æˆæƒç ï¼šæçŸ­ï¼Œé˜²æ­¢ä¸­é—´äººæ‹¦æˆª (å»ºè®® 5-10m)
    authorizationCodeAt: 5m
    # è®¿é—®ä»¤ç‰Œï¼šä¸­ç­‰ï¼Œå¹³è¡¡ä½“éªŒä¸å®‰å…¨ (å»ºè®® 30m-2h)
    accessTokenAt: 2h
    # åˆ·æ–°ä»¤ç‰Œï¼šé•¿ï¼Œç”¨äºç»´æŒç™»å½•æ€ (å»ºè®® 7d-30d)
    refreshTokenAt: 30d
    # [æ–°å¢] è®¾å¤‡ç ï¼šç”¨äº TV/IoT è®¾å¤‡ç™»å½• (å»ºè®® 15m-30m)
    deviceCodeAt: 15m
    # [æ–°å¢] æ—¶é—´åå·®ï¼šå…è®¸æœåŠ¡å™¨æ—¶é’Ÿæœ‰ 60ç§’ çš„è¯¯å·®
    skew: 60

    # 3. ä»¤ç‰Œè¡Œä¸ºç­–ç•¥
    # å»ºè®®è®¾ä¸º false (æ¯æ¬¡åˆ·æ–°éƒ½æ¢æ–°çš„ RefreshToken)ï¼Œå®‰å…¨æ€§æ›´é«˜
    # å¦‚æœè®¾ä¸º trueï¼ŒRefresh Token æ³„éœ²åå¦‚æœä¸æ‰‹åŠ¨æ’¤é”€ï¼Œé»‘å®¢å¯ä»¥ä¸€ç›´ç”¨
    reuseRefreshToken: false

    # 4. [æ–°å¢] å¯†é’¥åº“é…ç½® (Server æ ¸å¿ƒå¿ƒè„)
    # å¿…é¡»ç”Ÿæˆ jks æ–‡ä»¶æ”¾åœ¨ resources/keystore ç›®å½•ä¸‹
    keyStore:
      type: jks                               # ç±»å‹: jks æˆ– pfx
      path: "keys/oauth2.jks"                 # è·¯å¾„: classpath ä¸‹
      alias: "zero-jwt-key"                   # åˆ«å: ç”Ÿæˆè¯ä¹¦æ—¶æŒ‡å®šçš„ -alias
      password: "${KEYSTORE_PASS:changeit}"   # å¯†ç : å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥

    # 5. OIDC åè®®é…ç½®
    oidc:
      userClaims: true        # æ˜¯å¦åœ¨ UserInfo ç«¯ç‚¹è¿”å›è‡ªå®šä¹‰ Claims

    # 6. é¢„ç½®å®¢æˆ·ç«¯ ID åˆ—è¡¨
    # å…·ä½“ Client è¯¦æƒ…è¯·é…ç½®åœ¨ JDBC æ•°æ®åº“æˆ– oauth2.registration ä¸­
    clients: [ ]

# -----------------------------------------------------------------
# 4. ğŸ”‘ OAuth2 å®¢æˆ·ç«¯æ³¨å†Œ (Registration) - [Root Node]
# -----------------------------------------------------------------
oauth2:
  endpoint: "http://${Z_API_HOST:localhost}:${Z_API_PORT:7185}/"
  registration:
    zero-desktop-app:
      provider: zero-provider
      client-id: zero-desktop-app
      client-authentication-method: none
      authorization-grant-type: authorization_code
      redirect-uri: ${oauth2.endpoint}oauth2/authorized/zero-desktop-app
      scope: openid,profile,email
      client-name: ZERO Desktop Application
      client-setting:
        require-proof-key: true
        require-authorization-consent: true

    zero-web-app:
      provider: zero-provider
      client-id: zero-web-app
      client-secret: "{bcrypt}$2a$10$XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX" # [å·²è„±æ•]
      client-authentication-method: client_secret_basic
      authorization-grant-type: authorization_code
      redirect-uri: ${oauth2.endpoint}oauth2/authorized/zero-web-app
      scope: openid,profile,email,api.read,api.write
      client-name: ZERO Web Application

    # ==========================================
    # ğŸ“Œ [æ–°å¢] ç”¨äºæµ‹è¯• client_credentials çš„å®¢æˆ·ç«¯
    # ==========================================
    zero-client-app:
      provider: zero-provider
      client-id: zero-client-app           # ID
      client-secret: zero-client-secret    # å¯†ç  (æ˜æ–‡ï¼Œé€‚é…ä½ å½“å‰ä»£ç )
      client-authentication-method: client_secret_basic
      authorization-grant-type: client_credentials  # å…³é”®ï¼šå¿…é¡»åŒ¹é…ä»£ç é€»è¾‘
      redirect-uri: ""                     # æœºå™¨æ¨¡å¼ä¸éœ€è¦å›è°ƒåœ°å€
      scope: api:read,api:write            # æƒé™èŒƒå›´
      client-name: ZERO Client Application

  provider:
    zero-provider:
      # ä½¿ç”¨å®Œæ•´çš„é…ç½®è€Œä¸æ˜¯ä¾èµ– issuer-uri
      authorization-uri: ${oauth2.endpoint}/oauth2/authorize
      token-uri: ${oauth2.endpoint}/oauth2/token
      user-info-uri: ${oauth2.endpoint}/userinfo
      jwk-set-uri: ${oauth2.endpoint}/oauth2/jwks
      user-name-attribute: username

# -----------------------------------------------------------------
# 5. ğŸ”Œ ç¬¬ä¸‰æ–¹é›†æˆ (Integrations) - [Root Nodes]
# -----------------------------------------------------------------
# ğŸ“Œ å¾®ä¿¡ç›¸å…³é…ç½®
weco:
  # å¾®ä¿¡å…¬ä¼—å·é…ç½®
  wechat-mp:
    expire-seconds: 300
    app-id: ${R2MO_WECHAT_MP_APP}
    secret: ${R2MO_WECHAT_MP_SECRET}
    token: ${R2MO_WECHAT_MP_TOKEN}
  # å¼€æ”¾å¹³å°é…ç½®
  # wechat-open:
  #   app-id: ${R2MO_WECHAT_OPEN_APP}
  #   secret: ${R2MO_WECHAT_OPEN_SECRET}
  #   redirect-uri: https://jacque-nonbusiness-leslee.ngrok-free.dev/auth/wechat-callback

  # ä¼ä¸šé…ç½®
  wecom-cp:
    corp-id: ${R2MO_WECOM_CORP_ID}
    secret: ${R2MO_WECOM_SECRET}
    agent-id: 1000002
    url-callback: https://auth.r2mo.io/auth/wecom-login

# ğŸ“Œ é‚®ç®±æœåŠ¡å™¨ï¼ˆç‹¬ç«‹é…ç½®ï¼‰
email:
  username: admin@example.com
  password: ${R2MO_EMAIL_PASS}
  smtp:
    host: smtp.126.com
    port: 465
    ssl: true
    timeout: 10000

# ğŸ“Œ çŸ­ä¿¡éªŒè¯ï¼ˆç‹¬ç«‹é…ç½®ï¼‰
sms:
  access_id: ${R2MO_ALI_ID}
  access_secret: ${R2MO_ALI_SECRET}
  sign_name: "è™æµª"

# -----------------------------------------------------------------
# 6. ğŸ¢ ä¸šåŠ¡ä¸åº”ç”¨é…ç½® (Business)
# -----------------------------------------------------------------
app:
  id: "UUID-APP-ID-PLACEHOLDER"
  ns: "io.zerows.apps"
  tenant: "UUID-TENANT-ID-PLACEHOLDER"
  data:
    copyright: "R2MO Tech"
  config:
    demo: false

storage:
# type: local
# path: /var/tmp/

plugins:
  io.zerows.extension.commerce.rbac.plugins.request.DataRegion:
    prefix: /api/
  io.zerows.extension.commerce.rbac.plugins.request.AuditorPin:
    include:
      - /api/mcard/publish
      - /api/order/standard/submit
      - /api/order/direct/submit
      - /api/order/check-in/submit
      - /api/cancel-work/order

excel:
  pen: "io.zerows.plugins.office.excel.tpl.BlueTpl"
  temp: /tmp/
  tenant: "init/environment.json"

# -----------------------------------------------------------------
# 7. âš™ï¸ ç›‘æ§ä¸ä»»åŠ¡ (System & Monitor)
# -----------------------------------------------------------------
job:
  enabled: true

cache:
  ehcache:
    expiredAt: 3m
  caffeine:
    expiredAt: 3m
  redis:
    expiredAt: 30s

monitor:
  server:
    jmx-port: 7188
    monitor-type: PROMETHEUS_GRAFANA
    monitor-config:
      port: 17190